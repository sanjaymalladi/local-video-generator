# 🎬 Daytona Integration for Real MP4 Video Generation

## 🎯 **Why Use Daytona?**

- ✅ **$200 Free Compute** - Generous free tier for testing and development
- ✅ **Scale to Zero** - Pay only when generating videos
- ✅ **Full Python Support** - Perfect for Manim execution
- ✅ **Fast Spin-up** - Millisecond deployment
- ✅ **Secure Sandboxes** - Isolated execution environment
- ✅ **GPU Support** - High-performance video rendering

## 🚀 **Quick Start**

### **Step 1: Set Up Daytona Sandbox**

```bash
# Navigate to the Daytona sandbox directory
cd daytona-sandbox

# Make the setup script executable
chmod +x setup-daytona.sh

# Run the setup script
./setup-daytona.sh
```

### **Step 2: Configure Vercel Environment**

```bash
# Run the environment setup script
node setup-env.js

# Choose option 1 (Daytona) when prompted
# Enter your Daytona sandbox URL
```

### **Step 3: Deploy to Vercel**

```bash
npm run deploy
```

## 🛠 **Architecture Overview**

```
User Query → Vercel Edge Function → Gemini AI → Manim Code → Daytona Sandbox → Real MP4 Video
```

### **Flow Details:**

1. **User submits query** through the web interface
2. **Vercel Edge Function** receives the request
3. **Gemini AI** generates Manim Python code
4. **Daytona Sandbox** executes the Manim code
5. **Real MP4 video** is generated and uploaded to cloud storage
6. **Video URL** is returned to the user

## 📁 **File Structure**

```
local-video-generator/
├── daytona-sandbox/           # Daytona sandbox files
│   ├── app.py                 # Flask API for video generation
│   ├── requirements.txt       # Python dependencies
│   ├── Dockerfile            # Container configuration
│   ├── setup-daytona.sh      # Setup script
│   └── env.example           # Environment variables template
├── src/app/api/generate/     # Vercel API route
│   └── route.ts              # Updated with Daytona integration
└── setup-env.js              # Environment configuration script
```

## 🔧 **Configuration**

### **Environment Variables**

```bash
# Required for Daytona integration
DAYTONA_SANDBOX_URL=https://your-sandbox.daytona.io

# Optional: API key if needed
DAYTONA_API_KEY=your_api_key

# Cloud storage for videos (choose one)
CLOUD_STORAGE=cloudinary  # or 's3'

# Cloudinary configuration
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# AWS S3 configuration (alternative)
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1
S3_BUCKET=your-video-bucket
```

### **Daytona Sandbox Configuration**

The Daytona sandbox runs a Flask API with these endpoints:

- `GET /health` - Health check
- `POST /generate-video` - Generate video from Manim code
- `GET /status` - Service status

## 💰 **Cost Analysis**

### **Daytona Free Tier:**
- **$200 credit** included
- **Estimated usage:**
  - Simple videos: ~4000 videos
  - Complex videos: ~2000 videos
  - High-quality videos: ~1000 videos

### **Cost Comparison:**

| Service | Free Tier | Cost per Video | Setup |
|---------|-----------|----------------|-------|
| **Daytona** | $200 credit | $0.01-0.05 | Medium |
| **Replicate** | None | $0.01-0.10 | Easy |
| **RunPod** | Limited | $0.20-0.50/hour | Hard |

## 🎬 **Video Generation Process**

### **1. Manim Code Generation**
```python
# Example Manim code generated by Gemini AI
from manim import *

class ExplanationScene(Scene):
    def construct(self):
        # Create mathematical animation
        circle = Circle()
        self.play(Create(circle))
        self.wait(2)
```

### **2. Daytona Execution**
```bash
# Daytona sandbox executes:
manim script.py ExplanationScene -qh --output_file=scene.mp4
```

### **3. Video Upload**
- Generated MP4 is uploaded to cloud storage
- Public URL is returned to Vercel
- Video is served to the user

## 🔄 **Fallback Strategy**

The system includes multiple fallback options:

1. **Primary**: Daytona (free tier)
2. **Fallback 1**: Replicate API
3. **Fallback 2**: RunPod API
4. **Final Fallback**: Mock SVG videos

```typescript
// Fallback logic in generate route
try {
  return await callDaytonaAPI(manimCode, query);
} catch (error) {
  try {
    return await generateVideoWithReplicate(manimCode);
  } catch (error) {
    try {
      return await generateVideoWithRunPod(manimCode);
    } catch (error) {
      return createMockVideo(jobId, query);
    }
  }
}
```

## 🚀 **Deployment Steps**

### **1. Set Up Daytona Account**
```bash
# Sign up at https://daytona.io
# Install Daytona CLI
curl -fsSL https://download.daytona.io/daytona/install.sh | sh

# Login to Daytona
daytona login
```

### **2. Deploy Daytona Sandbox**
```bash
cd daytona-sandbox
./setup-daytona.sh
```

### **3. Configure Vercel**
```bash
# Run setup script
node setup-env.js

# Choose Daytona option and enter sandbox URL
```

### **4. Deploy Application**
```bash
npm run deploy
```

## 🔍 **Monitoring & Debugging**

### **Daytona Sandbox Logs**
```bash
# View sandbox logs
daytona sandbox logs your-sandbox-name

# Check sandbox status
daytona sandbox status your-sandbox-name
```

### **Vercel Function Logs**
```bash
# View Vercel function logs
vercel logs --follow
```

### **Health Checks**
```bash
# Check Daytona sandbox health
curl https://your-sandbox.daytona.io/health

# Check Vercel deployment
curl https://your-app.vercel.app/api/health
```

## 🛡 **Security Considerations**

### **Sandbox Isolation**
- Each video generation runs in an isolated environment
- Temporary files are automatically cleaned up
- No persistent storage between requests

### **API Security**
- Environment variables for sensitive data
- CORS configuration for web requests
- Input validation and sanitization

### **Resource Limits**
- 5-minute timeout for video generation
- Memory and CPU limits per sandbox
- Automatic cleanup of temporary files

## 📊 **Performance Optimization**

### **Video Quality Settings**
```python
# Configurable quality levels
quality_flags = {
    '480p': '-ql',   # Low quality (fast)
    '720p': '-qm',   # Medium quality
    '1080p': '-qh',  # High quality
    '4k': '-qk'      # Ultra quality (slow)
}
```

### **Caching Strategy**
- Generated videos are cached in cloud storage
- Public URLs for direct access
- CDN distribution for fast loading

## 🔧 **Troubleshooting**

### **Common Issues**

#### **1. Daytona Sandbox Not Responding**
```bash
# Check sandbox status
daytona sandbox status your-sandbox-name

# Restart sandbox if needed
daytona sandbox restart your-sandbox-name
```

#### **2. Manim Execution Fails**
```bash
# Check Manim installation
daytona sandbox exec your-sandbox-name -- manim --version

# View detailed logs
daytona sandbox logs your-sandbox-name
```

#### **3. Video Upload Fails**
- Check cloud storage credentials
- Verify network connectivity
- Check file size limits

### **Debug Commands**
```bash
# Test Daytona API directly
curl -X POST https://your-sandbox.daytona.io/generate-video \
  -H "Content-Type: application/json" \
  -d '{"code":"from manim import *\nclass Test(Scene):\n    def construct(self):\n        self.add(Circle())","query":"test"}'

# Check environment variables
vercel env ls
```

## 🎯 **Next Steps**

### **Immediate Actions:**
1. Set up Daytona account and sandbox
2. Configure environment variables
3. Test video generation
4. Deploy to production

### **Future Enhancements:**
1. Add video quality selection
2. Implement video preview thumbnails
3. Add batch video generation
4. Integrate with more cloud storage options

## 📞 **Support**

- **Daytona Documentation**: https://docs.daytona.io
- **Manim Documentation**: https://docs.manim.community
- **Vercel Documentation**: https://vercel.com/docs

---

**🎉 You're now ready to generate real MP4 videos with Daytona!** 